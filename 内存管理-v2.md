## å†…å­˜ç®¡ç†-v2

### C++ç¨‹åºåˆ†é…å†…å­˜çš„é€”å¾„

![IMG_5683A2594FC2-1](assets/IMG_5683A2594FC2-1.jpeg)

è¯´æ˜ï¼š

1. é¦–å…ˆ`new`æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå› æ­¤æ˜¯ä¸å¯ä»¥é‡è½½çš„ã€‚å½“æˆ‘ä»¬ä½¿ç”¨`Foo* p = new Foo(x);`æ—¶ï¼Œç¼–è¯‘å™¨éƒ½ä¼šè¿›å…¥ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°ï¼š

   ```cpp
   Foo* p = (Foo*)operator new(sizeof(Foo));
   new(p) Foo(x);
   ```

   å› ä¸ºæ˜¯å‡½æ•°ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥é‡è½½çš„ã€‚

2. `operator new`çš„è·¯å¾„æœ‰ä¸¤æ¡ï¼Œé»˜è®¤æ˜¯èµ°å…¨å±€çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€‰æ‹©é‡è½½ç±»çš„`operator new`ï¼Œæ”¹å˜å†…å­˜çš„èµ°å‘ï¼Œä½†æ˜¯æ— è®ºå¦‚ä½•ï¼Œéƒ½ä¼šç»è¿‡`::operator new`è¿›å…¥`malloc`ä¸­ã€‚

### C++å®¹å™¨ åˆ†é…å†…å­˜çš„é€”å¾„

![image-20200303000509401](assets/image-20200303000509401.png)



### é‡è½½`::operator new`å’Œ`::operator delete`çš„ä¾‹å­

ä»£ç å¦‚ä¸‹ï¼š

```cpp
void* my_malloc(size_t size) {
  return malloc(size);
}

void my_free(void* ptr) {
  free(ptr);
}

// ä¸‹é¢ä¸¤ä¸ªéƒ½ä¸èƒ½è¢«å£°æ˜åœ¨namesapceä¸­
// é‡è½½ä¸€ä¸‹::operator new && ::operator delete
inline void* operator new(size_t size) {
  // éªŒè¯æ˜¯å¦è¢«æ¥ç®¡
  cout << "sanjay global new()" << endl;
  return my_malloc(size);
}

inline void operator delete(void* ptr){
  cout << "sanjay global delete()" << endl;
  my_free(ptr);
}

// ä¸»å‡½æ•°æ‰§è¡Œï¼š
int* p = new int;
delete p;


// outputï¼š
sanjay global new()
sanjay global delete()
```

ä»¥ä¸Šä»£ç æ‰§è¡Œç»“æœè¯æ˜ï¼Œå…¨å±€çš„`operator new && delete`ç¡®å®è¢«æˆ‘ä»¬æ¥ç®¡äº†ã€‚



### é‡è½½ç±»å†…`operator new`å’Œ`operator delete`çš„ä¾‹å­

```cpp
class Foo{
public:
  int id_;
  Foo() : id_(0) {cout << "default ctor" << endl;}
  ~Foo() { cout << "dtor " << endl;}

  // è¿™é‡Œä¸å†™staticä¹Ÿå¯ä»¥ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åŠ ä¸Š
  static void* operator new(size_t size);
  static void operator delete(void* pdead, size_t size);
};
void *Foo::operator new(size_t size) {
  Foo* p = (Foo*)malloc(size);
  cout << "foo operator new" << endl;
  return p;
}
void Foo::operator delete(void *pdead, size_t size) {
  cout << "foo operator delete" << endl;
  free(pdead);
}

void test() {
  Foo* p = new Foo;
  delete p;

  // ä¸‹é¢æ˜¯å¼ºåˆ¶ä½¿ç”¨global çš„operator new
  Foo* p1 = ::new Foo;
  ::delete p1;
}
```

è¾“å‡ºç»“æœæ˜¯ï¼š

```shell
foo operator new
default ctor
# å…ˆè°ƒç”¨ææ„ï¼Œå†é‡Šæ”¾å†…å­˜
dtor 
foo operator delete
# è°ƒç”¨å…¨å±€çš„
default ctor
dtor 
```

### é‡è½½`new()`å’Œ`delete()`

è¿™ä¸ªä¹Ÿå°±æ˜¯é‡è½½ç±»çš„æˆå‘˜å‡½æ•°`operator new å’Œ delete`ï¼Œä½†æ˜¯ï¼Œé‡è½½çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»ä¸º`size_t`ç±»å‹ï¼Œå…¶ä½™å‚æ•°ä»¥newæ‰€æŒ‡å®šçš„placement argumentä½œä¸ºåˆå€¼ï¼Œå‡ºç°åœ¨`new(...)`å°æ‹¬å·å†…çš„ä¾¿æ˜¯æ‰€è°“çš„placement argumentsäº†ã€‚å¦‚ï¼š

`Foo* pf = new(200, 'c')Foo;`

å¯ä»¥é‡è½½ç±»å†…æˆå‘˜å‡½æ•°operator delete()ï¼Œä½†æ˜¯ä¸ä¼šè°ƒç”¨deleteï¼Œå› ä¸ºå®é™…ä¸Šé‡è½½operator newæ˜¯æ²¡æœ‰åˆ†é…å†…å­˜çš„ã€‚

ğŸŒ°ï¼š

```cpp
// åœ¨Fooçš„åŸºç¡€ä¸Šå¢åŠ çš„
class Foo{
 public:
  //...
  // é‡è½½operator new
  static void*operator new(size_t size, void* start);
  static void operator delete(void*, void*);
};

void *Foo::operator new(size_t size, void *start) {
  cout << "Foo::operator new(size_t, void*)" << endl;
  return start;
}
void Foo::operator delete(void *, void *) {
  cout << "Foo::operator delete" << endl;
}

// æµ‹è¯•
void test_new() {
  Foo start;
  Foo* p1 = new Foo;
  Foo* p2 = new(&start)Foo;
}
```

è¾“å‡ºç»“æœä¸ºï¼š

```shell
# Foo startçš„è¾“å‡º
default ctor
# Foo* p1 = new Foo;çš„è¾“å‡º
foo operator new
default ctor
# Foo* p2 = new(&start)Foo;
Foo::operator new(size_t, void*)
default ctor # ä¼šè§¦å‘æ„é€ å‡½æ•°
# startæ ˆçš„é‡Šæ”¾
dtor
```

**æ³¨æ„åˆ°ï¼Œplacement newä¼šè§¦å‘æ„é€ å‡½æ•°ã€‚**

